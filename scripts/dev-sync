#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Load environment
ENV_FILE="$PROJECT_DIR/.env"
if [[ ! -f "$ENV_FILE" ]]; then
    echo "Error: .env file not found. Copy .env.example to .env and configure it."
    exit 1
fi
source "$ENV_FILE"

# Validate required variables
for var in VM_HOST VM_USER VM_PASS VM_NIXOS_PATH; do
    if [[ -z "${!var:-}" ]]; then
        echo "Error: $var is not set in .env"
        exit 1
    fi
done

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  sync      Sync files to VM (default)"
    echo "  rebuild   Sync and rebuild NixOS"
    echo "  boot      Sync and set as boot config (no switch)"
    echo "  check     Run nix flake check on VM"
    echo "  ssh       Open SSH session to VM"
    echo ""
}

sync_files() {
    echo -e "${YELLOW}Syncing files to $VM_USER@$VM_HOST:$VM_NIXOS_PATH...${NC}"

    local TEMP_PATH="/home/$VM_USER/nixos-sync"

    # Step 1: rsync to user's home (no sudo needed)
    sshpass -p "$VM_PASS" rsync -avz --delete \
        --exclude='.git' \
        --exclude='.env' \
        --exclude='result' \
        --exclude='result-*' \
        "$PROJECT_DIR/" \
        "$VM_USER@$VM_HOST:$TEMP_PATH/"

    # Step 2: sudo rsync from temp to /etc/nixos (preserve .git for flake)
    run_on_vm rsync -a --delete --exclude='.git' "$TEMP_PATH/" "$VM_NIXOS_PATH/"

    # Step 3: ensure git repo exists and files are committed (required for flakes)
    sshpass -p "$VM_PASS" ssh "$VM_USER@$VM_HOST" "echo '$VM_PASS' | sudo -S bash -c 'cd $VM_NIXOS_PATH && \
        if [ ! -d .git ]; then \
            git init && \
            git config user.email vm@local && \
            git config user.name VM && \
            git config --global --add safe.directory $VM_NIXOS_PATH; \
        fi && \
        git add -A && \
        (git diff-index --quiet HEAD 2>/dev/null || git commit -m \"sync from host\")'"

    echo -e "${GREEN}Sync complete!${NC}"
}

run_on_vm() {
    sshpass -p "$VM_PASS" ssh "$VM_USER@$VM_HOST" "echo '$VM_PASS' | sudo -S $*"
}

cmd_sync() {
    sync_files
}

cmd_rebuild() {
    sync_files
    echo -e "${YELLOW}Rebuilding NixOS...${NC}"
    run_on_vm nixos-rebuild switch --flake "$VM_NIXOS_PATH#vm"
    echo -e "${GREEN}Rebuild complete!${NC}"
}

cmd_boot() {
    sync_files
    echo -e "${YELLOW}Setting boot configuration...${NC}"
    run_on_vm nixos-rebuild boot --flake "$VM_NIXOS_PATH#vm"
    echo -e "${GREEN}Boot config set! Reboot to apply.${NC}"
}

cmd_check() {
    sync_files
    echo -e "${YELLOW}Running flake check...${NC}"
    run_on_vm nix flake check "$VM_NIXOS_PATH"
    echo -e "${GREEN}Flake check passed!${NC}"
}

cmd_ssh() {
    sshpass -p "$VM_PASS" ssh "$VM_USER@$VM_HOST"
}

# Main
COMMAND="${1:-sync}"

case "$COMMAND" in
    sync)    cmd_sync ;;
    rebuild) cmd_rebuild ;;
    boot)    cmd_boot ;;
    check)   cmd_check ;;
    ssh)     cmd_ssh ;;
    -h|--help|help) usage ;;
    *)
        echo "Unknown command: $COMMAND"
        usage
        exit 1
        ;;
esac
